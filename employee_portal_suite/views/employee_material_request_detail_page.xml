<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="employee_material_request_detail_page" name="Material Request Detail">
        <t t-call="employee_portal_suite.employee_portal_layout">

            <div class="container mt-4 employee-req-detail">

                <!-- ========================= -->
                <!-- PAGE TITLE -->
                <!-- ========================= -->
                <h2 class="mb-4">Material Request Details</h2>
                    <t t-if="request_rec.state in ['approved', 'rejected']">
                        <a t-att-href="'/my/employee/material/pdf/%s' % request_rec.id"
                        class="btn btn-outline-primary mb-3">
                            Download PDF
                        </a>
                    </t>
                    <t t-if="request_rec.state == 'rejected'">
                        <div class="alert alert-danger">
                            <strong>Rejected at stage:</strong>
                            <t t-esc="request_rec.state_before_reject"/> â€”
                            <strong>Reason:</strong>
                            <t t-esc="request_rec.get_rejection_reason()"/>
                        </div>
                    </t>

                <!-- ========================= -->
                <!-- BASIC REQUEST INFO -->
                <!-- ========================= -->
                <table class="table table-bordered" style="background: #fff;">
                    <tr>
                        <th style="width: 180px;">Request Number</th>
                        <td><t t-esc="request_rec.name"/></td>
                    </tr>
                    <tr>
                        <th>Employee</th>
                        <td><t t-esc="request_rec.employee_id.name"/></td>
                    </tr>
                    <tr>
                        <th>Worksite</th>
                        <td><t t-esc="request_rec.worksite"/></td>
                    </tr>
                    <tr>
                        <th>Delivery Date</th>
                        <td><t t-esc="request_rec.delivery_date"/></td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td><t t-raw="status_badge(request_rec)"/></td>
                    </tr>
                    <tr>
                        <th>Date</th>
                        <td><t t-esc="request_rec.request_date"/></td>
                    </tr>
                </table>

                <!-- ========================= -->
                <!-- MATERIAL LINES -->
                <!-- ========================= -->
                <h4 class="mt-4">Requested Materials</h4>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Required Quantity</th>
                            <th>Unit of Measure</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="request_rec.line_ids" t-as="line">
                            <tr>
                                <td><t t-esc="line.item_name"/></td>
                                <td><t t-esc="line.qty_required"/></td>
                                <td><t t-esc="line.uom_id.name"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            <!-- ========================= -->
            <!-- ATTACHMENT LIST (NEW)    -->
            <!-- ========================= -->
            <h4 class="mt-4">Attachments</h4>

            <t t-if="attachments">
                <ul class="list-group">
                    <t t-foreach="attachments" t-as="att">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="ms-2">
                                <t t-esc="att.name"/> 
                                (<t t-esc="att.description or 'General'"/>)
                            </span>

                            <!-- DOWNLOAD -->
                            <a t-att-href="'/web/content/%s?download=true' % att.id"
                            class="btn btn-sm btn-outline-secondary"
                            target="_blank">
                                Download
                            </a>

                            <!-- VIEW -->
                            <a t-att-href="'/web/content/%s' % att.id"
                            class="btn btn-sm btn-outline-primary"
                            target="_blank">
                                View
                            </a>

                            <a t-att-href="'/my/employee/material/attachment/delete/%s/%s' % (att.id, request_rec.id)"
                            class="text-danger small"
                            onclick="return confirm('Delete this attachment?');">
                                âœ–
                            </a>

                        </li>
                    </t>
                </ul>
            </t>

            <t t-else="">
                <p>No attachments uploaded.</p>
            </t>
            <!-- ========================= -->
            <!-- ATTACHMENT UPLOADER (NEW) -->
            <!-- ========================= -->
            <h4 class="mt-4">Upload New Attachments</h4>

            <form method="post" action="/my/employee/material/attachment/upload"
                enctype="multipart/form-data">

                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <input type="hidden" name="req_id" t-att-value="request_rec.id"/>

                <select name="attachment_tag" class="form-select mb-2" style="max-width:250px;">
                    <option value="General">General</option>
                    <option value="BOQ">BOQ</option>
                    <option value="Quotation">Quotation</option>
                    <option value="Image">Image</option>
                    <option value="Receipt">Receipt</option>
                </select>

                <div id="dropzone-detail"
                    class="border rounded p-4 text-center bg-light"
                    style="cursor:pointer;">
                    <p class="text-muted mb-0">Drag and drop files here, or click to upload</p>
                    <input type="file" name="attachments"
                        id="fileInput-detail"
                        class="d-none"
                        multiple="multiple"/>
                </div>

                <div id="previewArea-detail" class="mt-3"></div>

                <button type="submit" class="btn btn-primary mt-3">Upload</button>
            </form>

                <!-- ========================= -->
                <!-- APPROVAL TIMELINE UI     -->
                <!-- ========================= -->
                <div class="card p-3 mt-4">
                    <h4 class="mb-3">Approval Timeline</h4>

                    <t t-if="request_rec.get_portal_timeline()">
                        <ul class="timeline">
                            <t t-foreach="request_rec.get_portal_timeline()" t-as="ev">
                                <li class="timeline-item">
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <h5 class="timeline-title">
                                            <t t-esc="ev['stage']"/>
                                        </h5>

                                        <t t-if="ev['approved_by']">
                                            <p><strong>By:</strong> <t t-esc="ev['approved_by']"/></p>
                                        </t>

                                        <p><strong>Date:</strong> <t t-esc="ev['date']"/></p>

                                        <t t-if="ev['comment']">
                                            <p><strong>Comment:</strong> <t t-esc="ev['comment']"/></p>
                                        </t>
                                    </div>
                                </li>
                            </t>
                        </ul>
                    </t>

                    <t t-if="not request_rec.get_portal_timeline()">
                        <p>No approval activity yet.</p>
                    </t>
                </div>

                <a href="/my/employee/material" class="btn btn-secondary mt-4">Back</a>
            </div>
                <!-- ========================= -->
                <!-- TIMELINE CSS              -->
                <!-- ========================= -->
                <style>
                    .timeline {
                        list-style: none;
                        padding-left: 20px;
                        position: relative;
                        margin-left: 10px;
                    }

                    .timeline:before {
                        content: "";
                        position: absolute;
                        top: 0;
                        bottom: 0;
                        width: 2px;
                        background: #c5c5c5;
                        left: 8px;
                    }

                    .timeline-item {
                        position: relative;
                        margin-bottom: 20px;
                    }

                    .timeline-marker {
                        position: absolute;
                        width: 16px;
                        height: 16px;
                        background: #0d6efd;
                        border-radius: 50%;
                        left: 0px;
                        top: 5px;
                    }

                    .timeline-content {
                        margin-left: 30px;
                        padding: 10px 15px;
                        background: #f8f9fa;
                        border-radius: 5px;
                        border: 1px solid #dee2e6;
                    }

                    .timeline-title {
                        margin: 0 0 5px 0;
                        font-size: 16px;
                        font-weight: 600;
                    }
                </style>

            <script>
            function setupDropzone(zoneId, inputId, previewId) {
                const dropzone = document.getElementById(zoneId);
                const fileInput = document.getElementById(inputId);
                const previewArea = document.getElementById(previewId);

                if (!dropzone || !fileInput) return;

                dropzone.addEventListener("click", () => fileInput.click());

                dropzone.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    dropzone.classList.add("bg-warning");
                });

                dropzone.addEventListener("dragleave", () => {
                    dropzone.classList.remove("bg-warning");
                });

                dropzone.addEventListener("drop", (e) => {
                    e.preventDefault();
                    dropzone.classList.remove("bg-warning");

                    const dt = new DataTransfer();
                    for (let i = 0; i &lt; e.dataTransfer.files.length; i++) {
                        dt.items.add(e.dataTransfer.files[i]);
                    }

                    fileInput.files = dt.files;

                    previewFiles(fileInput.files, previewArea);
                });


                fileInput.addEventListener("change", () => {
                    previewFiles(fileInput.files, previewArea);
                });
            }

            function previewFiles(files, previewArea) {
                previewArea.innerHTML = "";

                for (let file of files) {
                    let div = document.createElement("div");
                    div.className = "mt-2";

                    if (file.type.startsWith("image/")) {
                        let reader = new FileReader();
                        reader.onload = (e) => {
                            div.innerHTML = `
                                <img src="${e.target.result}" class="img-thumbnail" style="max-width:120px;"/>
                                <p>${file.name}</p>`;
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === "application/pdf") {
                        div.innerHTML = `<p>ðŸ“„ PDF: ${file.name}</p>`;
                    } else {
                        div.innerHTML = `<p>ðŸ“Ž ${file.name}</p>`;
                    }

                    previewArea.appendChild(div);
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                setupDropzone("dropzone-detail", "fileInput-detail", "previewArea-detail");
            });
            </script>


        </t>
    </template>

</odoo>
